<aside>

**项目定位**：基于 Fastify 构建的全功能 AI SaaS 后端，具备完整用户体系、流式对话能力和数据持久化，可独立**link-ai**部署或作为小程序/Web 应用的统一后端。

</aside>

---

## 项目背景

### 核心目标

1. **用户体系**：基于 PostgreSQL 实现完整的注册、登录、JWT 鉴权流程
2. **AI 对话**：集成 OpenAI/DeepSeek 接口，支持打字机流式输出（SSE）
3. **数据持久化**：自动保存用户对话记录，支持历史回溯
4. **工程化规范**：TypeScript + Prisma ORM，确保类型安全

---

## 系统架构

### 技术栈

| 类别 | 选型 | 说明 |
| --- | --- | --- |
| 运行时 | Node.js 20+ | LTS 版本 |
| 框架 | Fastify 5.x | 高性能，JSON Schema 原生支持 |
| 语言 | TypeScript 5.x | 强类型约束 |
| 数据库 | PostgreSQL | 用户数据 + 对话记录 |
| ORM | Prisma | Schema 定义 + 迁移管理 |
| 缓存 | Redis | 限流计数、Token 黑名单 |
| AI SDK | OpenAI Node SDK | 通用适配器模式 |

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                      客户端层                            │
│         微信小程序  /  Web App  /  CLI 工具              │
└─────────────────────┬───────────────────────────────────┘
                      │ HTTP / SSE
                      ▼
┌─────────────────────────────────────────────────────────┐
│             Nexus AI Backend (本项目)                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │ 用户模块 │ │ 鉴权模块 │ │ 对话模块 │ │ 限流模块 │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
└─────────────────────┬───────────────────────────────────┘
                      │
          ┌───────────┼───────────┐
          ▼           ▼           ▼
   ┌───────────┐ ┌─────────┐ ┌─────────┐
   │PostgreSQL │ │  Redis  │ │ LLM API │
   └───────────┘ └─────────┘ └─────────┘
```

---

## 数据库设计

### User 用户表

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| id | Int | Yes | 主键，自增 |
| email | String | Yes | 唯一，登录账号 |
| password | String | Yes | Bcrypt Hash 加密存储 |
| nickname | String | No | 用户昵称 |
| createdAt | DateTime | Yes | 注册时间 |

### Chat 对话表

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| id | Int | Yes | 主键，自增 |
| userId | Int | Yes | 外键，关联 [User.id](http://User.id) |
| title | String | No | 对话标题 |
| model | String | Yes | 使用的模型 |
| content | JSON | Yes | 对话数组 `[{role, content}]` |
| createdAt | DateTime | Yes | 创建时间 |

---

## 功能模块

### 模块一：认证授权

| 功能 | 接口 | 说明 | 鉴权 |
| --- | --- | --- | --- |
| 注册 | `POST /auth/register` | 邮箱 + 密码 + 昵称，密码 Bcrypt 加密 | 否 |
| 登录 | `POST /auth/login` | 返回 JWT Token | 否 |
| 鉴权 Hook | - | 除 `/auth/*` 外全局拦截 | - |

### 模块二：AI 对话

| 功能 | 接口 | 说明 | 鉴权 |
| --- | --- | --- | --- |
| 发送消息 | `POST /chat/send` | SSE 流式响应，完成后异步入库 | 是 |
| 历史记录 | `GET /chat/history` | 分页查询当前用户对话 | 是 |

### 模块三：系统治理

| 功能 | 说明 |
| --- | --- |
| 速率限制 | 单用户每分钟 20 次 AI 调用，超限返回 429 |
| 健康检查 | `GET /health` 返回服务状态 |

---

## 开发计划

| 阶段 | 耗时 | 目标 | 关键任务 |
| --- | --- | --- | --- |
| Day 1 | 1 天 | 基建搭建 | Fastify + TS 初始化，Docker 启动 PG/Redis，Prisma Migration |
| Day 2 | 1 天 | 用户中心 | 注册/登录接口，bcryptjs + @fastify/jwt，onRequest Hook |
| Day 3-4 | 2 天 | AI 对话 | OpenAI SDK 集成，SSE 流式响应，对话入库 |
| Day 5 | 1 天 | 完善交付 | JSON Schema 校验，Redis 限流，Postman 全流程测试 |

**总计**：约 5 天

---

## 验收标准

- [ ]  数据库中用户密码必须加密存储
- [ ]  不带 Token 无法访问 AI 接口
- [ ]  AI 响应必须是流式（逐字显示）
- [ ]  TypeScript 无类型报错

---

## 目录结构

```
nexus-ai-backend/
├── src/
│   ├── index.ts              # 入口
│   ├── app.ts                # Fastify 实例
│   ├── config/
│   │   └── env.ts            # 环境变量
│   ├── plugins/
│   │   ├── prisma.ts         # 数据库插件
│   │   ├── auth.ts           # JWT 鉴权
│   │   └── rateLimit.ts      # 限流
│   ├── routes/
│   │   ├── auth.ts           # 注册/登录
│   │   ├── chat.ts           # AI 对话
│   │   └── health.ts         # 健康检查
│   ├── services/
│   │   ├── user.service.ts   # 用户逻辑
│   │   └── ai.service.ts     # LLM 调用
│   └── utils/
│       └── stream.ts         # SSE 工具
├── prisma/
│   └── schema.prisma         # 数据模型
├── docker-compose.yml
├── .env.example
├── package.json
└── tsconfig.json
```