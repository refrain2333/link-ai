# link-ai 项目框架文档

## 目录

1. [项目概览](#项目概览)
2. [项目初始化](#项目初始化)
3. [文件结构](#文件结构)
4. [配置文件](#配置文件)
5. [核心模块](#核心模块)
6. [开发工作流](#开发工作流)
7. [数据库设计](#数据库设计)
8. [API 结构](#api-结构)

---

## 项目概览

**项目名称**: link-ai  
**技术栈**: Fastify + TypeScript + Prisma + PostgreSQL + Redis  
**包管理器**: pnpm  
**Node.js 版本**: 20+

### 核心目标

- 用户认证体系（注册、登录、JWT）
- AI 流式对话能力（OpenAI/DeepSeek）
- 对话记录持久化
- 生产级安全防护（限流、Token 管理）

---

## 项目初始化

### 第1步：初始化 npm 项目

```bash
npm init -y
```

### 第2步：配置 package.json

编辑 `package.json`，确保包含以下内容：

```json
{
  "name": "link-ai",
  "version": "1.0.0",
  "description": "一个基于 Fastify 构建的全功能 AI SaaS 后端",
  "main": "dist/index.js",
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "prisma:migrate": "prisma migrate dev",
    "prisma:studio": "prisma studio",
    "prisma:reset": "prisma migrate reset"
  },
  "packageManager": "pnpm@10.28.0"
}
```

### 第3步：安装依赖

```bash
pnpm add fastify prisma @prisma/client redis jsonwebtoken bcrypt dotenv cors
pnpm add -D typescript ts-node @types/node tsx
```

### 第4步：初始化 TypeScript

创建 `tsconfig.json`：

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node"
  },
  "include": ["src"],
  "exclude": ["node_modules"]
}
```

### 第5步：创建环境变量文件

创建 `.env`：

```
# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/link_ai

# Redis
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=your-secret-key-here

# OpenAI
OPENAI_API_KEY=sk-xxx

# 应用配置
NODE_ENV=development
PORT=3000
```

创建 `.env.example`（用于 git 提交）：

```
DATABASE_URL=postgresql://user:password@localhost:5432/link_ai
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-secret-key-here
OPENAI_API_KEY=sk-xxx
NODE_ENV=development
PORT=3000
```

### 第6步：初始化 Prisma

```bash
npx prisma init
```

这会创建 `prisma/` 文件夹和 `prisma/schema.prisma`

---

## 文件结构

创建以下文件夹和文件结构：

```
link-ai/
│
├── src/
│   ├── routes/
│   │   ├── auth.ts                 # 认证路由
│   │   ├── chat.ts                 # 对话路由
│   │   ├── user.ts                 # 用户路由
│   │   └── index.ts                # 路由入口
│   │
│   ├── services/
│   │   ├── authService.ts          # 认证业务逻辑
│   │   ├── chatService.ts          # 对话业务逻辑
│   │   ├── userService.ts          # 用户业务逻辑
│   │   └── openaiService.ts        # OpenAI 集成
│   │
│   ├── middleware/
│   │   ├── auth.ts                 # JWT 认证中间件
│   │   ├── errorHandler.ts         # 错误处理
│   │   └── rateLimit.ts            # 限流中间件
│   │
│   ├── db/
│   │   ├── prisma.ts               # Prisma 客户端
│   │   └── redis.ts                # Redis 客户端
│   │
│   ├── types/
│   │   ├── user.ts                 # 用户类型
│   │   ├── message.ts              # 消息类型
│   │   ├── request.ts              # 请求类型
│   │   └── index.ts                # 公共类型
│   │
│   ├── config/
│   │   └── constants.ts            # 常量定义
│   │
│   └── index.ts                    # 应用入口
│
├── prisma/
│   ├── schema.prisma               # 数据库 Schema
│   └── migrations/                 # 迁移记录（自动生成）
│
├── dist/                           # 编译后的代码（自动生成）
├── node_modules/                   # 依赖包（自动生成）
│
├── z_docs/
│   ├── 技术文档.md
│   ├── 说明文档.md
│   ├── 项目框架文档.md            # 本文件
│   ├── API文档.md
│   └── 数据库设计.md
│
├── package.json
├── pnpm-lock.yaml
├── tsconfig.json
├── .env
├── .env.example
├── .gitignore
├── README.md
└── .git/
```

---

## 配置文件

### `tsconfig.json`

配置 TypeScript 编译选项：
- `target: ES2020` - 编译目标
- `outDir: ./dist` - 输出目录
- `rootDir: ./src` - 源代码目录
- `strict: true` - 严格模式

### `.env` vs `.env.example`

| 文件 | 用途 | 是否提交 git |
|------|------|------------|
| `.env` | 实际配置（含敏感信息） | 不提交 ❌ |
| `.env.example` | 配置模板（无敏感信息） | 提交 ✓ |

### `prisma/schema.prisma`

定义数据库表结构，例如：

```prisma
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  Message[]
  @@map("users")
}

model Message {
  id        String   @id @default(cuid())
  userId    String
  content   String
  role      String   // "user" 或 "assistant"
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  @@map("messages")
}
```

---

## 核心模块

### 1. 认证模块 (`routes/auth.ts` + `services/authService.ts`)

**职责**:
- 用户注册
- 用户登录
- 返回 JWT Token

**路由**:
```
POST /auth/register    // 注册
POST /auth/login       // 登录
POST /auth/logout      // 登出
```

### 2. 对话模块 (`routes/chat.ts` + `services/chatService.ts`)

**职责**:
- 接收用户消息
- 调用 OpenAI API
- 流式返回回复
- 保存对话记录

**路由**:
```
POST /chat/message      // 发送消息（流式）
GET  /chat/history      // 获取历史记录
```

### 3. 用户模块 (`routes/user.ts` + `services/userService.ts`)

**职责**:
- 获取用户信息
- 更新用户信息
- 查询 Token 消耗

**路由**:
```
GET  /user/profile      // 获取个人信息
PUT  /user/profile      // 更新个人信息
GET  /user/tokens       // 查询 Token 余额
```

### 4. 中间件层 (`middleware/`)

**auth.ts** - JWT 验证中间件
```typescript
// 验证每个请求的 JWT Token
// 如果有效，将用户信息附加到 request.user
```

**errorHandler.ts** - 错误处理中间件
```typescript
// 捕获所有错误，统一返回错误响应
```

**rateLimit.ts** - 限流中间件
```typescript
// 使用 Redis 计数
// 限制用户或 IP 的请求频率
```

### 5. 数据库层 (`db/`)

**prisma.ts** - Prisma 连接
```typescript
import { PrismaClient } from '@prisma/client'

export const prisma = new PrismaClient()
```

**redis.ts** - Redis 连接
```typescript
import { createClient } from 'redis'

export const redis = createClient({ url: process.env.REDIS_URL })
```

---

## 开发工作流

### 本地开发

1. **启动服务器**:
   ```bash
   pnpm dev
   ```
   会自动监听代码变化并重启

2. **修改代码**:
   编辑 `src/` 下的文件，保存自动重启

3. **测试 API**:
   用 Postman 或 curl 测试接口

### 数据库操作

1. **修改 schema**:
   编辑 `prisma/schema.prisma`

2. **创建迁移**:
   ```bash
   pnpm prisma:migrate
   ```

3. **查看数据库**:
   ```bash
   pnpm prisma:studio
   ```
   打开可视化工具

4. **重置数据库** (开发用):
   ```bash
   pnpm prisma:reset
   ```

### 生产部署

1. **编译代码**:
   ```bash
   pnpm build
   ```

2. **启动服务**:
   ```bash
   pnpm start
   ```

---

## 数据库设计

### 核心表

#### `users` 表
```sql
id          STRING   PRIMARY KEY
email       STRING   UNIQUE
password    STRING
name        STRING
createdAt   DATETIME
updatedAt   DATETIME
```

#### `messages` 表
```sql
id          STRING   PRIMARY KEY
userId      STRING   FOREIGN KEY
content     STRING
role        STRING   (user/assistant)
createdAt   DATETIME
```

#### `conversations` 表
```sql
id          STRING   PRIMARY KEY
userId      STRING   FOREIGN KEY
title       STRING
createdAt   DATETIME
updatedAt   DATETIME
```

---

## API 结构

### 请求格式

所有请求都应该遵循这个格式：

```json
{
  "method": "POST/GET/PUT/DELETE",
  "path": "/api/path",
  "headers": {
    "Authorization": "Bearer <token>",
    "Content-Type": "application/json"
  },
  "body": {
    "key": "value"
  }
}
```

### 响应格式

成功响应:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "123",
    "name": "John"
  }
}
```

错误响应:
```json
{
  "code": -1,
  "message": "error message",
  "data": null
}
```

---

## 下一步

1. ✅ 完成项目初始化
2. ✅ 创建文件结构
3. ⏳ 编写 Prisma Schema
4. ⏳ 实现认证模块
5. ⏳ 实现对话模块
6. ⏳ 集成 OpenAI API
7. ⏳ 添加限流、错误处理
8. ⏳ 部署到生产环境

---

## 常用命令速查

| 命令 | 作用 |
|------|------|
| `pnpm dev` | 开发模式 |
| `pnpm build` | 编译代码 |
| `pnpm start` | 生产启动 |
| `pnpm prisma:migrate` | 数据库迁移 |
| `pnpm prisma:studio` | 数据库可视化 |
| `pnpm prisma:reset` | 重置数据库 |

