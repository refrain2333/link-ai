// Prisma Schema 配置文件
// 文档: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 消息角色枚举
enum Role {
  SYSTEM    // 系统设定
  USER      // 用户输入
  ASSISTANT // AI 回复
}

// 用户身份枚举
enum UserRole {
  USER      // 普通用户
  ADMIN     // 管理者
}

// 用户模型
model User {
  id           String    @id @default(cuid())
  email        String    @unique             // 邮箱（登录账号）
  password     String                        // 哈希后的密码
  name         String?                       // 昵称
  avatar       String?                       // 头像地址
  role         UserRole  @default(USER)      // 身份
  createdAt    DateTime  @default(now())     // 注册时间
  updatedAt    DateTime  @updatedAt           // 更新时间
  lastLoginAt  DateTime?                     // 最后登录时间
  lastLoginIp  String?                       // 最后登录 IP

  chats        Chat[]                        // 关联：用户拥有的对话
}

// 对话模型
model Chat {
  id        String   @id @default(cuid())
  title     String   @default("新对话")    // 对话标题
  userId    String                       // 所属用户 ID
  createdAt DateTime @default(now())     // 创建时间
  updatedAt DateTime @updatedAt           // 最后活跃时间

  // 关系定义：关联用户，支持级联删除
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]                    // 关联：对话下的所有消息

  @@index([userId])                    // 用户 ID 索引
}

// AI 模型配置表
model AIModel {
  id          String   @id @default(cuid())
  name        String                     // 显示名称（如：DeepSeek-V3）
  modelId     String   @unique           // 实际调用 ID（如：deepseek-chat）
  provider    String                     // 供应商（如：DeepSeek）
  baseUrl     String?                    // 独立的 API 代理地址
  apiKey      String?                    // 独立的 API 密钥
  
  enabled     Boolean  @default(true)    // 是否启用
  
  createdAt   DateTime @default(now())   // 创建时间
  updatedAt   DateTime @updatedAt         // 更新时间
}

// 消息模型
model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text            // 消息正文
  reasoning String?  @db.Text            // 思考过程（DeepSeek/o1 等专用）
  role      Role     @default(USER)      // 消息角色
  
  // 弱绑定：记录当时使用的模型信息
  modelName String?                      // 当时的显示名称
  modelId   String?                      // 当时的 API ID
  
  duration  Float?                      // 生成耗时（秒）
  
  // Token 细化统计
  promptTokens     Int      @default(0)  // 提问消耗 (Input)
  completionTokens Int      @default(0)  // 回答消耗 (Output)
  totalTokens      Int      @default(0)  // 总消耗 (Input + Output)
  
  metadata  Json?                        // 扩展元数据（如引用来源等）
  
  chatId    String                       // 所属对话 ID
  createdAt DateTime @default(now())     // 发送时间

  // 关系定义：关联对话，支持级联删除
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])                    // 对话 ID 索引
}
